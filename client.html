<html>
<meta name='viewport' content='width=device-width, initial-scale=1.0'>

<title>uRiego</title>


<style>
.btn {
  background-color: #4CAF50; /* Green */
  border: none;
  color: white;
  padding: 15px 32px;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 16px;
}
.btn2 {background-color: #008CBA;} /* Blue */
.btn_stop {background-color: #d66;} /* Red */
.btn_status {background-color: #666;} /* Gray */

</style>

<body>

  <script type="module">
    import { createApp } from '/static/petite-vue-module.min.js'
    var host = ''

    async function getAPI(endpoint){
        let url = host + '/' + endpoint;
        let headers =  {
            'Content-type': 'text/plain'
        };
        let request = {
            method:"GET",
            headers
        };
        let page = await fetch(url,request);
        let json = await page.json();
        console.log(json);
        return json
    }

    async function postAPI(endpoint, payload){
        let url = host + '/' + endpoint;
        let data = {"auth_token":"1234", "payload":payload}
        let headers =  {
            'Content-type': 'text/plain'
        };
        //console.log(headers)
        console.log(data)
        let request = {
            method:"POST",
            body:JSON.stringify(data),
            headers
        };
        let page = await fetch(url,request);
        let json = await page.json();
        console.log(json);
        return json
    }

    createApp({
      refreshPeriod: 2,
      status: {voltages: {}},
      history_cfg: {},
      history: {},
      refresh: false,
      async statusRefresh(){
        this.refresh = ! this.refresh
        this.getStatus(true)
      },
      async getStatus(repeat){
        this.status['voltages'] = await getAPI('voltages')
        if(repeat && this.refresh){
          let self = this
          setTimeout(function (){self.getStatus(repeat)}, 1000 * this.refreshPeriod)
        }
      },
      async setHistoryCfg(){
        this.getHistoryCfg(await postAPI('history', this.history_cfg))
      },
      async getHistoryCfg(cfg){
        if(!cfg)
            this.history_cfg = await getAPI('history')
        else
            this.history_cfg = cfg
        if(this.history_cfg.hasOwnProperty('history'))
            delete this.history_cfg.history
      },
      async toggleHistory(){
        let cfg = await getAPI('history')
        this.history = await postAPI('history', {enabled: !cfg.enabled})
      },
      async refreshHistory(){
        this.history = await getAPI('history')
      },
      async resistOn(){
        await getAPI('resiston')
      },
      async resistOff(){
        await getAPI('resistoff')
      },
      async mounted(){
        await this.getHistoryCfg()
      },
    }).mount()
  </script>

  <div v-scope @vue:mounted="mounted">
    <h2>Cfg</h2>
    <p><input type='checkbox' id='max_size' v-model='history_cfg.enabled'/> enabled </p>
    <p><input type='number' id='max_size' v-model='history_cfg.max_size'/> max size </p>
    <p><input type='number' id='period_tics' v-model='history_cfg.period_tics'/> period in tics </p>
    <p><input type='number' id='save_period_sec' v-model='history_cfg.save_period_sec'/> save_period_sec </p>
    <p><button id='toggleHistory' class='btn btn_status' @click='setHistoryCfg()'>Set Cfg</button> <button id='refreshHistory' class='btn btn_status' @click='getHistoryCfg()'>Get Cfg</button></p>
    <p><pre>{{history_cfg}}</pre></p>
    <p/>
    <hr/>
    <p><button id='resiston' class='btn btn_status' @click='resistOn()'>Resistance On</button></p>
    <p><button id='resistoff' class='btn btn_status' @click='resistOff()'>Resistance Off</button></p>
    <hr/>
    <p><button id='status' class='btn btn_status' @click='statusRefresh()'>Refresh</button> {{refresh}}
       <input type='number' id='refresh-period' v-model='refreshPeriod'/> period sec</p>
      <p>
        <ul id="runningList">
          <li v-for="value, name in status.voltages">
            {{ name }}: {{ value }}
          </li>
        </ul>
      </p>
    <hr/>
    <p><button id='refreshHistory' class='btn btn_status' @click='refreshHistory()'>View History</button></p>
    <p><pre>{{history}}</pre></p>
    <p/>
  </div>

</body>



</html>

